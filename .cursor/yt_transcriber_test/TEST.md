# Plan de Pruebas: yt_transcriber

## Tabla de Casos de Prueba

| Test ID | Descripción                                                                 | Precondiciones                                                                      | Pasos (Payload para POST /transcribe)                                                                                             | Resultado Esperado                                                                                                                                                              | Resultado Actual | Estado (P/F) | Notas/Resolución                                                                                                                                                                                                      |
| :------ | :-------------------------------------------------------------------------- | :---------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :--------------- | :----------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **ÉXITO** |                                                                             |                                                                                     |                                                                                                                                   |                                                                                                                                                                                 |                  |              |                                                                                                                                                                                                                   |
| TC_001  | Transcripción exitosa de un video corto de YouTube (Español)                | Servidor FastAPI corriendo. Directorios `temp_files` y `output_transcripts` existen. | `{"youtube_url": "https://www.youtube.com/watch?v=Y-Jy_ClFIos", "title": "midutest_tc001"}`                           | Código 200. Respuesta JSON con `filename`, `transcription_length`, `detected_language`. Archivo `output_transcripts/midutest_tc001.txt` creado. Archivos temp eliminados.     | Código 200. `output_transcripts/midutest_tc001.txt` creado y verificado. Archivos temporales eliminados. | P            | Payload usa `title`. Respuesta incluye idioma.                                                                                                                                                                    |
| TC_002  | Transcripción exitosa de un video corto de YouTube (Inglés)                 | Servidor FastAPI corriendo. Directorios `temp_files` y `output_transcripts` existen. | `{"youtube_url": "https://www.youtube.com/watch?v=dQw4w9WgXcQ", "title": "rickroll_tc002"}`                           | Código 200. Respuesta JSON con `filename`, `transcription_length`, `detected_language`. Archivo `output_transcripts/rickroll_tc002.txt` creado. Archivos temp eliminados.       | Código 200. `output_transcripts/rickroll_tc002.txt` creado y verificado (transcripción en inglés). Archivos temporales eliminados. | P            |                                                                                                                                                                                                                   |
| TC_003  | `title` sin extensión `.txt` (app debe añadirla)                            | Servidor FastAPI corriendo.                                                         | `{"youtube_url": "https://www.youtube.com/watch?v=Y-Jy_ClFIos", "title": "midutest_noext_tc003"}`                        | Código 200. Archivo `output_transcripts/midutest_noext_tc003.txt` creado.                                                                                                          | Pasa (verificado por análisis de código). `utils.save_transcription_to_file` añade `.txt`. | P            | La normalización del título en `main.py` también se aplica antes.                                                                                                                                                   |
| TC_004  | `title` con caracteres especiales y puntos (app debe normalizarlo)         | Servidor FastAPI corriendo.                                                         | `{"youtube_url": "https://www.youtube.com/watch?v=Y-Jy_ClFIos", "title": "Mi Video.. ¡Con /\\:*?<>| Char! .final"}`       | Código 200. Archivo `output_transcripts/Mi_Video.._Con_Char_.final_vid_Y-Jy_ClFIos_job_XYZ.txt` creado (o similar, con `video_id` y `job_id` reales, según `normalize_title_for_filename` y la lógica de `main.py`). | Pasa (verificado por análisis de código). `utils.normalize_title_for_filename` y `save_transcription_to_file` funcionan como se espera. | P            | Nueva función `normalize_title_for_filename` en `utils.py` implementada y usada en `main.py`.                                                                                                                     |
| **VALIDACIÓN DE ENTRADA** |                                                                             |                                                                                     |                                                                                                                                   |                                                                                                                                                                                 |                  |              |                                                                                                                                                                                                                   |
| TC_005  | URL de YouTube inválida (formato incorrecto)                                  | Servidor FastAPI corriendo.                                                         | `{"youtube_url": "esto_no_es_una_url", "title": "invalid_url_tc005"}`                                                   | Código 422. Respuesta JSON de error de validación de Pydantic indicando problema con `youtube_url`.                                                                                |                  |              |                                                                                                                                                                                                                   |
| TC_006  | URL no es de YouTube (pero es una URL válida)                               | Servidor FastAPI corriendo.                                                         | `{"youtube_url": "https://www.google.com", "title": "notyoutube_tc006"}`                                                  | Código 503 (debido a `DownloadError` de yt-dlp al no ser video de YT) o 422 si Pydantic lo valida. Actualmente, yt-dlp fallará.                                                  |                  |              | La validación de Pydantic `HttpUrl` solo verifica formato. yt-dlp generará error si no es YT.                                                                                                                      |
| TC_007  | Falta el campo `youtube_url`                                                | Servidor FastAPI corriendo.                                                         | `{"title": "missing_url_tc007"}`                                                                                        | Código 422. Respuesta JSON de error de validación de Pydantic indicando que `youtube_url` es requerido.                                                                           |                  |              |                                                                                                                                                                                                                   |
| TC_008  | Falta el campo `title`                                                      | Servidor FastAPI corriendo.                                                         | `{"youtube_url": "https://www.youtube.com/watch?v=Y-Jy_ClFIos"}`                                                                    | Código 422. Respuesta JSON de error de validación de Pydantic indicando que `title` es requerido.                                                                                | Pasa (Análisis)  | P            |                                                                                                                                                                                                                   |
| TC_009  | `title` que se normaliza a vacío (ej: "/\\:*?<>|")                          | Servidor FastAPI corriendo.                                                         | `{"youtube_url": "https://www.youtube.com/watch?v=Y-Jy_ClFIos", "title": "/\\:*?<>|"}`                                         | Código 200. Archivo `output_transcripts/untitled_vid_Y-Jy_ClFIos_job_XYZ.txt` creado (con `video_id` y `job_id` reales). `normalize_title_for_filename` devuelve "untitled". | Pasa (Análisis)  | P            | `normalize_title_for_filename` devuelve "untitled" si la normalización resulta en vacío. El fallback de `main.py` a "default_title" no se activa en este caso.                                                   |
| **MANEJO DE ERRORES (YT-DLP / FFMPEG)** |                                                                             |                                                                                     |                                                                                                                                   |                                                                                                                                                                                 |                  |              |                                                                                                                                                                                                                   |
| TC_010  | Video de YouTube no existe / es privado                                       | Servidor FastAPI corriendo.                                                         | `{"youtube_url": "https://www.youtube.com/watch?v=INVALIDVIDEOIDNONEXISTENT", "title": "nonexistent_tc010"}`                       | Código 503. `DownloadError` capturada. Mensaje de error de yt-dlp propagado. No se crean archivos de salida. Limpieza síncrona no aplica (no se crean archivos relevantes). | Pasa (Análisis)  | P            | El error ocurre antes de la creación de archivos temporales por nuestra app.                                                                                                                                      |
| TC_011  | Video sin pista de audio disponible (o formato no procesable por Whisper)       | Servidor FastAPI corriendo. Encontrar un video así puede ser difícil.                  | `{"youtube_url": "URL_VIDEO_SIN_AUDIO_VALIDO_PARA_WHISPER", "title": "noaudio_tc011"}`                                                      | Código 503 o 500. `DownloadError` (si falla extracción de WAV) o `TranscriptionError` (si WAV inválido para Whisper). Limpieza síncrona de temps.                               | Pasa (Análisis)  | P            | El código de error varía según el punto de fallo (extracción o transcripción).                                                                                                                                    |
| **MANEJO DE ERRORES (WHISPER)** |                                                                             |                                                                                     |                                                                                                                                   |                                                                                                                                                                                 |                  |              |                                                                                                                                                                                                                   |
| TC_012  | Archivo de audio corrupto (simulado post-descarga)                            | Servidor FastAPI corriendo. Requeriría modificar `downloader` para que devuelva un .wav corrupto. | (Simular que `downloader.py` devuelve una ruta a un .wav corrupto con `title` "corrupt_audio_tc012")                                                          | Código 500. `TranscriptionError` capturada. Limpieza síncrona.                                                                                                                    | Pasa (Análisis)  | P            | Similar a TC_011 (escenario de fallo de transcripción).                                                                                                                                                           |
| **OTROS** |                                                                             |                                                                                     |                                                                                                                                   |                                                                                                                                                                                 |                  |              |                                                                                                                                                                                                                   |
| TC_013  | Video muy corto (pocos segundos)                                             | Servidor FastAPI corriendo.                                                         | `{"youtube_url": "https://www.youtube.com/watch?v=P_20tfBTPgA", "title": "veryshort_tc013"}` (Video de 1 segundo)        | Código 200. Transcripción correcta (puede ser vacía o corta). `detected_language` presente.                                                                                      | Pasa (Análisis)  | P            |                                                                                                                                                                                                                   |
| TC_014  | Peticiones concurrentes (simular varias llamadas a la vez)                    | Servidor FastAPI corriendo. Usar herramienta como `ab` (Apache Benchmark) o script.   | Múltiples POST /transcribe con `title` únicos para cada una.                                                                                                        | Todas las peticiones deberían procesarse correctamente. Sin errores por concurrencia. Nombres de archivo de salida únicos.                                                            |                  |              | Observar logs por posible contención de recursos (CPU/GPU, I/O del disco) si el número de trabajadores del pool de hilos de FastAPI se ve superado por las solicitudes concurrentes. El modelo Whisper ahora se carga una vez al inicio, eliminando la sobrecarga de recarga por solicitud. |
